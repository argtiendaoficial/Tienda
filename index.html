<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArgTienda - Catálogo Multivendor</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Carga de Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, where, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // *************************************************************************
        // *** ✅ CONFIGURACIÓN DE FIREBASE LISTA CON TUS CLAVES ✅ ***
        // *************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyBmtnNMZEY-jZHKOr76olK2e8iZgQc1GRg",
            authDomain: "argtienda-f452b.firebaseapp.com",
            projectId: "argtienda-f452b",
            storageBucket: "argtienda-f452b.firebasestorage.app",
            messagingSenderId: "717148466465",
            appId: "1:717148466465:web:f93c6653f73ea0412fa260"
        };
        
        // --- INICIALIZACIÓN DE FIREBASE Y VARIABLES GLOBALES ---
        
        // setLogLevel('Debug'); // Útil para ver logs de Firebase en la consola
        
        // Variables globales para Firestore y Auth (se llenan en window.onload)
        let __app_id = 'mercadov-default'; // ID por defecto si no está en entorno Canvas
        let db, auth;
        let userId = null; 
        
        // --- 2. SETUP DE LA APP ---
        window.setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación: Intentar usar token inicial, si no, anónima
                const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Si no hay token, iniciamos sesión anónimamente para que los clientes vean el catálogo.
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Auth State Changed: Usuario UID:", userId);
                        window.authStatus = user.isAnonymous ? 'anonymous' : 'vendor';
                        window.updateUI(); 
                        
                        // Si el usuario ya existe (es vendedor), se cargan sus productos.
                        if (window.authStatus === 'vendor') {
                            window.loadVendorProducts(userId);
                        }
                        // En cualquier caso, se cargan todos los productos para el catálogo público.
                        window.loadPublicCatalog(); 

                    } else {
                        // Si no hay usuario, cargamos solo el catálogo público.
                        userId = null;
                        window.authStatus = 'logged_out';
                        window.updateUI();
                        window.loadPublicCatalog();
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o en Auth:", error);
                window.showMessage("Error grave: No se pudo conectar a la base de datos. Revisá las claves de Firebase.", true);
                window.loadPublicCatalog([]); // Cargar catálogo vacío si falla
            }
        };

        // --- 3. GESTIÓN DE FIREBASE (CRUD) ---

        // Ruta de la colección pública (Catálogo)
        const getPublicCollectionPath = () => `/artifacts/${__app_id}/public/data/products`;
        // Ruta de la colección privada (Solo para gestión del vendedor)
        const getPrivateCollectionPath = (uid) => `/artifacts/${__app_id}/users/${uid}/products`;

        // Carga el catálogo público (TODOS los productos)
        window.loadPublicCatalog = () => {
            const productsCollectionRef = collection(db, getPublicCollectionPath());
            const q = query(productsCollectionRef);

            // onSnapshot escucha cambios en tiempo real
            onSnapshot(q, (snapshot) => {
                const products = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.currentProductsData = products; // Actualiza los datos globales
                window.loadCatalog(); // Vuelve a renderizar el catálogo público
                console.log(`Catálogo público cargado: ${products.length} productos.`);
            }, (error) => {
                console.error("Error al obtener el catálogo público:", error);
                window.showMessage("Error al cargar los productos del catálogo.", true);
            });
        };

        // Carga los productos del vendedor actual
        window.loadVendorProducts = (uid) => {
            const privateCollectionRef = collection(db, getPrivateCollectionPath(uid));
            const q = query(privateCollectionRef);

            onSnapshot(q, (snapshot) => {
                const products = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.vendorProducts = products; // Actualiza los datos del vendedor
                window.renderVendorProducts(products); // Renderiza en el Dashboard
                console.log(`Productos del vendedor ${uid} cargados: ${products.length}.`);
            }, (error) => {
                console.error("Error al obtener productos del vendedor:", error);
                window.showMessage("Error al cargar tus productos como vendedor.", true);
            });
        };
        
        // Función para guardar/editar un producto (lo hace en ambas colecciones)
        window.saveProduct = async (productData, productId = null) => {
            if (!userId || window.authStatus !== 'vendor') {
                window.showMessage("Debes iniciar sesión como vendedor para guardar productos.", true);
                return;
            }

            // Datos del vendedor se agregan al producto
            const productWithVendorInfo = {
                ...productData,
                vendorId: userId,
                vendorName: `Vendedor ${userId.substring(0, 8)}`, // Nombre de vendedor por defecto
                vendorWhatsapp: document.getElementById('vendorWhatsappInput').value || "+5491100000000" 
            };
            
            try {
                let publicDocRef;
                let privateDocRef;

                if (productId) {
                    // EDICIÓN: Usamos el mismo ID en ambas colecciones
                    publicDocRef = doc(db, getPublicCollectionPath(), productId);
                    privateDocRef = doc(db, getPrivateCollectionPath(userId), productId);
                    
                    await updateDoc(publicDocRef, productWithVendorInfo);
                    await updateDoc(privateDocRef, productWithVendorInfo);

                    window.showMessage("✅ Producto actualizado con éxito en el catálogo.", false);
                } else {
                    // CREACIÓN: Agregamos a la colección privada primero para obtener el ID
                    privateDocRef = await addDoc(collection(db, getPrivateCollectionPath(userId)), productWithVendorInfo);
                    const newId = privateDocRef.id;

                    // Luego agregamos a la colección pública con el mismo ID
                    publicDocRef = doc(db, getPublicCollectionPath(), newId);
                    await setDoc(publicDocRef, productWithVendorInfo);

                    window.showMessage("✅ Producto publicado con éxito en el catálogo.", false);
                }
                window.closeProductForm();
            } catch (error) {
                console.error("Error al guardar producto:", error);
                window.showMessage("Error al guardar el producto. " + error.message, true);
            }
        };

        // Función para eliminar un producto (lo hace en ambas colecciones)
        window.deleteProduct = async (productId) => {
            if (!userId || window.authStatus !== 'vendor' || !window.confirm("¿Estás seguro de que quieres ELIMINAR este producto?")) return;

            try {
                // Eliminar de la colección pública
                await deleteDoc(doc(db, getPublicCollectionPath(), productId));
                // Eliminar de la colección privada
                await deleteDoc(doc(db, getPrivateCollectionPath(userId), productId));

                window.showMessage("✅ Producto eliminado del catálogo.", false);
            } catch (error) {
                console.error("Error al eliminar producto:", error);
                window.showMessage("Error al eliminar el producto.", true);
            }
        };
    </script>
    <!-- FIN de Firebase SDKs -->

    <style>
        /* Estilos generales y fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .text-primary { color: #00b09b; } /* Color primario */
        .bg-primary { background-color: #00b09b; }
        .hover\:bg-primary-dark:hover { background-color: #008f80; }
        .whatsapp-btn { background-color: #25d366; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .whatsapp-btn:hover { background-color: #128c7e; }
        .view { display: none; }
        .image-tab { width: 50%; height: 100px; object-fit: cover; cursor: pointer; opacity: 0.7; transition: opacity 0.3s; }
        .image-tab.active { opacity: 1; border: 2px solid #00b09b; }
        /* Estilos específicos para el dashboard */
        .product-item { transition: all 0.2s ease; }
        .product-item:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6">
        <header class="mb-6 pb-4 border-b border-gray-200 sticky top-0 bg-white z-10">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg class="w-8 h-8 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path><path d="M15 7v2a4 4 0 01-4 4H9.863L9 17v-4h1.137A2 2 0 0013 9V7h1a2 2 0 012 2v4a2 2 0 01-2 2h-1.137l-3 3v-3H8a2 2 0 01-2-2V7h7z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                ArgTienda
            </h1>
            <p id="auth-status" class="text-sm mt-1 font-semibold text-gray-500">Cargando sesión de Firebase...</p>
            
            <div id="vendor-cta-container" class="flex justify-end mt-2 space-x-2">
                <!-- Botones de Vendedor -->
            </div>
        </header>

        <!-- Mensajes de Estado Global -->
        <div id="status-message" class="p-3 mb-4 rounded-lg text-sm font-medium hidden"></div>

        <!-- 1. VISTA PÚBLICA: CATÁLOGO DE PRODUCTOS -->
        <div id="catalogView" class="view">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Catálogo de Productos ArgTienda</h2>
            
            <div class="mb-6 flex space-x-2">
                <input type="text" id="productSearch" placeholder="Buscar producto por nombre..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition duration-150">
                <button onclick="searchProducts()" class="bg-primary text-white p-3 rounded-lg font-semibold hover:bg-primary-dark transition">Buscar</button>
            </div>

            <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- Los productos se cargarán aquí -->
            </div>
            <p id="no-products-message" class="text-center text-gray-500 mt-10 hidden">No se encontraron productos.</p>
        </div>

        <!-- 2. VISTA DASHBOARD DEL VENDEDOR -->
        <div id="vendorDashboardView" class="view">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Mi Panel de Vendedor</h2>
            
            <div class="p-4 bg-white rounded-xl shadow-md mb-6">
                <h3 class="text-xl font-semibold text-primary mb-3">Tu Información de Vendedor</h3>
                <p class="text-sm text-gray-600 mb-2">Tu ID (Compartir solo si es necesario): <span id="display-user-id" class="font-mono bg-gray-100 p-1 rounded">Cargando...</span></p>
                <div class="flex items-center space-x-2">
                    <label for="vendorWhatsappInput" class="font-medium text-gray-700">Tu WhatsApp (con código de país, ej: +549...):</label>
                    <input type="text" id="vendorWhatsappInput" placeholder="+54911..."
                           class="flex-grow p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition duration-150"
                           onchange="updateVendorWhatsapp(this.value)">
                </div>
                <p class="text-xs text-gray-500 mt-1">Este número se usará para recibir pedidos de tus productos.</p>
            </div>

            <button onclick="openProductForm()" class="bg-primary text-white px-6 py-3 rounded-xl font-bold hover:bg-primary-dark transition shadow-lg mb-6 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Añadir Nuevo Producto
            </button>
            
            <div id="vendorProductsList" class="space-y-4">
                <!-- Lista de productos del vendedor -->
            </div>
        </div>

        <!-- 3. MODAL DE DETALLE DE PRODUCTO (PÚBLICO) -->
        <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" onclick="closeProductDetailModal(event)">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div id="mainProductImageContainer" class="mb-4 rounded-lg overflow-hidden border border-gray-200">
                        <img id="detailImage" src="" alt="Imagen principal del producto" class="w-full h-auto max-h-72 object-cover object-center">
                    </div>
                    <div id="thumbnailContainer" class="flex gap-2 mb-4"></div>
                    
                    <h2 id="detailName" class="text-3xl font-extrabold text-gray-900 mb-1"></h2>
                    <p id="detailVendor" class="text-sm font-semibold text-gray-500 mb-4"></p>
                    <p id="detailPrice" class="text-4xl font-extrabold text-primary mb-4"></p>
                    <p id="detailDescription" class="text-gray-600 mb-6"></p>

                    <!-- Ficha técnica -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-bold text-lg mb-2 text-gray-700">Ficha Técnica</h4>
                        <ul class="text-sm space-y-1 text-gray-500">
                            <li>**Stock:** <span id="detailStock" class="font-semibold text-gray-700"></span></li>
                            <li>**Peso:** <span id="detailWeight" class="font-semibold text-gray-700"></span></li>
                            <li>**Alto:** <span id="detailHeight" class="font-semibold text-gray-700"></span></li>
                            <li>**Largo:** <span id="detailLength" class="font-semibold text-gray-700"></span></li>
                            <li>**Ancho:** <span id="detailWidth" class="font-semibold text-gray-700"></span></li>
                        </ul>
                    </div>

                    <button id="detailOrderBtn" 
                        class="whatsapp-btn w-full mt-6 flex items-center justify-center p-4 rounded-xl font-bold text-xl disabled:opacity-50"
                        onclick="handleOrderClick(this)">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.001 2.002c-5.524 0-10 4.478-10 10s4.476 10 10 10c1.789 0 3.461-.485 4.904-1.332l.385.24 2.81 2.81a.5.5 0 00.707 0 .5.5 0 000-.707l-2.81-2.81a.5.5 0 00-.24-.385c.847-1.443 1.332-3.115 1.332-4.904 0-5.522-4.476-10-10-10zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM15 9.002h-2v2h-2v-2h-2v2h-2v2h2v2h2v-2h2v-2h2v-2z" fill="#FFF"/></svg>
                        ¡HACER PEDIDO por WhatsApp!
                    </button>

                    <button onclick="closeProductDetailModal()" class="w-full text-gray-500 mt-2 hover:text-gray-700 transition">Cerrar</button>
                </div>
            </div>
        </div>
        
        <!-- 4. MODAL DE FORMULARIO DE PRODUCTO (VENDEDOR) -->
        <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-y-auto max-h-screen" onclick="event.stopPropagation()">
                <div class="p-6">
                    <h2 id="productFormTitle" class="text-2xl font-bold mb-4 text-gray-800">Añadir Nuevo Producto</h2>
                    <form id="productForm" onsubmit="event.preventDefault(); window.submitProductForm(this);">
                        <input type="hidden" id="productIdToEdit">

                        <div class="space-y-4">
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                                <input type="text" id="productName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                            </div>
                            <div>
                                <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio ($)</label>
                                <input type="number" step="0.01" id="productPrice" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                            </div>
                            <div>
                                <label for="productStock" class="block text-sm font-medium text-gray-700">Stock (Unidades)</label>
                                <input type="number" id="productStock" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                            </div>
                            <div>
                                <label for="productDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <textarea id="productDescription" rows="3" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea>
                            </div>
                            <div>
                                <label for="productImageUrls" class="block text
