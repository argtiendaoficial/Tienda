<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MercadoV Global - Catálogo Multivendor</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales y fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .text-primary { color: #00b09b; } /* Color primario similar a los ejemplos (verde/cian) */
        .bg-primary { background-color: #00b09b; }
        .hover\:bg-primary-dark:hover { background-color: #008f80; }
        /* Estilo para el botón de WhatsApp */
        .whatsapp-btn {
            background-color: #25d366;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .whatsapp-btn:hover {
            background-color: #128c7e;
        }
        /* Ocultar vistas por defecto */
        .view { display: none; }
        /* Estilo para las pestañas de la galería de imágenes */
        .image-tab {
            width: 50%;
            height: 100px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .image-tab.active {
            opacity: 1;
            border: 2px solid #00b09b;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6">
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg class="w-8 h-8 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path><path d="M15 7v2a4 4 0 01-4 4H9.863L9 17v-4h1.137A2 2 0 0013 9V7h1a2 2 0 012 2v4a2 2 0 01-2 2h-1.137l-3 3v-3H8a2 2 0 01-2-2V7h7z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                MercadoV Global
            </h1>
            <p id="auth-status" class="text-sm text-gray-500 mt-1">Cargando sesión de Firebase...</p>
            <!-- El botón de salir ahora está dentro de la lógica del script para mostrarse solo cuando está logueado -->
            <button id="logout-btn" class="hidden absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600 transition" onclick="logout()">Salir</button>
        </header>

        <!-- Mensajes de Estado Global -->
        <div id="status-message" class="p-3 mb-4 rounded-lg text-sm font-medium hidden"></div>

        <!-- 1. VISTA PÚBLICA: CATÁLOGO DE PRODUCTOS -->
        <div id="catalogView" class="view">
            <!-- BOTÓN AGREGADO ACÁ ARRIBA DEL CATÁLOGO -->
            <div class="flex justify-end mb-4" id="vendor-cta-container">
                <button onclick="showLoginModal()" class="bg-primary text-white px-4 py-2 rounded-full font-bold hover:bg-primary-dark transition shadow-lg text-sm sm:text-base">
                    Ingresar como Vendedor
                </button>
            </div>
            
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Catálogo de Productos</h2>
            
            <div class="mb-6 flex space-x-2">
                <input type="text" id="productSearch" placeholder="Buscar producto por nombre..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition duration-150">
                <button onclick="searchProducts()" class="bg-primary text-white p-3 rounded-lg font-semibold hover:bg-primary-dark transition">Buscar</button>
            </div>

            <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- Los productos se cargarán aquí -->
            </div>
            <p id="no-products-message" class="text-center text-gray-500 mt-10 hidden">No se encontraron productos.</p>
        </div>

        <!-- 2. VISTA DASHBOARD DEL VENDEDOR -->
        <div id="vendorDashboardView" class="view">
            <h2 class="text-3xl font-bold mb-6 text-primary">Mi Panel de Vendedor</h2>
            
            <!-- PESTAÑAS: PERFIL vs PRODUCTOS -->
            <div class="flex mb-6 border-b border-gray-300">
                <button id="tab-profile" onclick="switchVendorTab('profile')" class="tab-button py-2 px-4 text-lg font-semibold border-b-4 border-primary text-primary transition duration-150">Mi Perfil</button>
                <button id="tab-products" onclick="switchVendorTab('products')" class="tab-button py-2 px-4 text-lg font-semibold text-gray-500 border-b-4 border-transparent hover:border-gray-400 transition duration-150">Mis Productos</button>
            </div>

            <!-- CONTENIDO DE LA PESTAÑA PERFIL -->
            <div id="profileContent" class="tab-content bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Información de Contacto y Envío <span id="profileStatus" class="ml-2 text-sm font-medium"></span></h3>
                <p class="text-sm text-red-500 mb-4 font-semibold">⚠️ ¡Todos estos campos son obligatorios para publicar productos!</p>
                <form id="updateProfileForm" class="space-y-4">
                    <!-- Datos de Contacto -->
                    <input type="text" id="vendorIdDisplay" placeholder="ID Vendedor" disabled
                           class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg font-mono text-sm">
                    <input type="email" id="vendorEmailInput" placeholder="Correo Electrónico (No modificable)" disabled
                           class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg">
                    <input type="tel" id="vendorWhatsappInput" placeholder="WhatsApp (ej: +54 9 11 XXXX-XXXX)" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                    
                    <!-- Datos de Facturación / Envío -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="vendorDNIInput" placeholder="Número de DNI/CUIT/CUIL" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                        <input type="text" id="vendorCPInput" placeholder="Código Postal" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                    </div>
                    <textarea id="vendorAddressInput" placeholder="Dirección Completa (Calle, Número, Localidad)" required
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary h-16"></textarea>
                    
                    <button type="submit" class="w-full bg-primary text-white p-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition">Guardar mi Perfil</button>
                </form>
            </div>

            <!-- CONTENIDO DE LA PESTAÑA PRODUCTOS -->
            <div id="productsContent" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 mb-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Añadir Nuevo Producto</h3>
                    <p id="publish-warning" class="text-sm p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden font-semibold">⚠️ Completá tu perfil (WhatsApp, DNI, Dirección, CP) antes de publicar.</p>
                    <form id="addProductForm" class="space-y-4">
                        <!-- Datos Principales -->
                        <input type="text" id="productName" placeholder="Nombre del Producto" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        <textarea id="productDescription" placeholder="Descripción breve" required
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary h-20"></textarea>
                        
                        <!-- Precio y Stock -->
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="productPrice" placeholder="Precio ($)" step="0.01" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <input type="number" id="productStock" placeholder="Stock disponible" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        
                        <!-- Dimensiones y Peso -->
                        <div class="space-y-2 border p-3 rounded-lg">
                            <p class="text-sm font-semibold text-gray-600">Dimensiones para Envío (en centímetros y gramos):</p>
                            <input type="number" id="productWeight" placeholder="Peso (gramos)" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <div class="grid grid-cols-3 gap-3">
                                <input type="number" id="productHeight" placeholder="Alto (cm)" required
                                       class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <input type="number" id="productLength" placeholder="Largo (cm)" required
                                       class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <input type="number" id="productWidth" placeholder="Ancho (cm)" required
                                       class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                        </div>

                        <!-- URLs de Imágenes -->
                        <div class="space-y-2 border p-3 rounded-lg">
                            <p class="text-sm font-semibold text-gray-600">Fotos del Producto (Máx 2 URLs):</p>
                            <input type="url" id="productImageUrl1" placeholder="URL Foto Principal (Obligatoria)" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <input type="url" id="productImageUrl2" placeholder="URL Foto Secundaria (Opcional)"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        
                        <button type="submit" id="publishBtn" class="w-full bg-primary text-white p-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition disabled:opacity-50" disabled>Publicar Producto</button>
                    </form>
                </div>

                <h3 class="text-2xl font-bold text-gray-700 mb-4">Mis Productos Publicados</h3>
                <div id="vendorProductList" class="space-y-4">
                    <!-- Lista de productos del vendedor -->
                </div>
                <p id="no-vendor-products-message" class="text-center text-gray-500 mt-10 hidden">Aún no tienes productos publicados.</p>
            </div>
        </div>

        <!-- 3. VISTA DETALLE DE PRODUCTO (MANTENIDA) -->
        <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" onclick="closeProductDetailModal(event)">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div id="mainProductImageContainer" class="mb-4 rounded-lg overflow-hidden border border-gray-200">
                        <img id="detailImage" src="" alt="Imagen principal del producto" class="w-full h-auto max-h-72 object-cover object-center">
                    </div>
                    <div id="thumbnailContainer" class="flex gap-2 mb-4">
                        <!-- Las miniaturas se cargarán aquí -->
                    </div>
                    
                    <h2 id="detailName" class="text-3xl font-extrabold text-gray-900 mb-1"></h2>
                    <p id="detailVendor" class="text-sm font-semibold text-gray-500 mb-4"></p>
                    
                    <p id="detailPrice" class="text-4xl font-extrabold text-primary mb-4"></p>
                    
                    <p id="detailDescription" class="text-gray-600 mb-6"></p>

                    <!-- Ficha técnica -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-bold text-lg mb-2 text-gray-700">Ficha Técnica</h4>
                        <ul class="text-sm space-y-1 text-gray-500">
                            <li>**Stock:** <span id="detailStock" class="font-semibold text-gray-700"></span></li>
                            <li>**Peso:** <span id="detailWeight" class="font-semibold text-gray-700"></span></li>
                            <li>**Alto:** <span id="detailHeight" class="font-semibold text-gray-700"></span></li>
                            <li>**Largo:** <span id="detailLength" class="font-semibold text-gray-700"></span></li>
                            <li>**Ancho:** <span id="detailWidth" class="font-semibold text-gray-700"></span></li>
                        </ul>
                    </div>

                    <button id="detailOrderBtn" 
                        class="whatsapp-btn w-full mt-6 flex items-center justify-center p-4 rounded-xl font-bold text-xl disabled:opacity-50"
                        onclick="handleOrderClick(this)">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.001 2.002c-5.524 0-10 4.478-10 10s4.476 10 10 10c1.789 0 3.461-.485 4.904-1.332l.385.24 2.81 2.81a.5.5 0 00.707 0 .5.5 0 000-.707l-2.81-2.81a.5.5 0 00-.24-.385c.847-1.443 1.332-3.115 1.332-4.904 0-5.522-4.476-10-10-10zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM15 9.002h-2v2h-2v-2h-2v2h-2v2h2v2h2v-2h2v-2h2v-2z" fill="#FFF"/></svg>
                        ¡HACER PEDIDO por WhatsApp!
                    </button>

                    <button onclick="closeProductDetailModal()" class="w-full text-gray-500 mt-2 hover:text-gray-700 transition">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- 4. MODAL DE LOGIN VENDEDOR (ACTUALIZADO) -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden" onclick="closeLoginModal(event)">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Ingresar como Vendedor</h3>
                <p class="text-sm text-gray-500 mb-4">Ingresá tu ID de Vendedor (ej: VND_XXXXXX) que te fue proporcionado.</p>
                <form id="loginForm" class="space-y-4">
                    <input type="text" id="loginIdInput" placeholder="Tu ID de Vendedor" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                    <button type="submit" id="loginSubmitBtn" disabled class="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition disabled:opacity-50">
                        Ingresar
                    </button>
                </form>
                
                <div class="mt-6 border-t pt-4">
                    <p class="text-sm font-semibold mb-2 text-gray-700">¿No tenés un ID?</p>
                    <button onclick="requestVendorId()" class="whatsapp-btn w-full flex items-center justify-center p-3 rounded-lg font-bold text-sm">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.001 2.002c-5.524 0-10 4.478-10 10s4.476 10 10 10c1.789 0 3.461-.485 4.904-1.332l.385.24 2.81 2.81a.5.5 0 00.707 0 .5.5 0 000-.707l-2.81-2.81a.5.5 0 00-.24-.385c.847-1.443 1.332-3.115 1.332-4.904 0-5.522-4.476-10-10-10zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM15 9.002h-2v2h-2v-2h-2v2h-2v2h2v2h2v-2h2v-2h2v-2z" fill="#FFF"/></svg>
                        Solicitar ID por WhatsApp
                    </button>
                </div>
                <button onclick="closeLoginModal()" class="w-full text-gray-500 mt-4 hover:text-gray-700 transition text-sm">Cerrar</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración de Firebase y Variables Globales
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app;
        let db;
        let auth;
        let userId = null;
        let userRole = 'public'; // Solo 'public' o 'vendor'
        let currentVendorProfile = {}; // Almacena todos los datos del perfil
        let currentVendorTab = 'profile'; // Pestaña activa del vendedor
        let isAuthReady = false; // Estado para saber cuándo Firebase terminó la autenticación inicial

        // Constantes de Firestore
        const FIREBASE_COLLECTIONS = {
            USERS: `artifacts/${appId}/public/data/users`, // Colección pública de perfiles (donde están los IDs de vendedor)
            PRODUCTS: `artifacts/${appId}/public/data/products` // Colección pública de productos
        };
        
        // --- CONFIGURACIÓN DE CONTACTO DE ADMINISTRACIÓN (NÚMERO ACTUALIZADO) ---
        const ADMIN_CONTACT = {
            whatsappNumber: '+5492664987050', // Número de WhatsApp del Administrador/Gestor de IDs
            name: 'Administración MercadoV'
        };


        // --- FUNCIONES DE UTILIDAD Y MODALES ---

        function showMessage(text, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = text;
            statusDiv.className = `p-3 mb-4 rounded-lg text-sm font-medium ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            statusDiv.classList.remove('hidden');
            setTimeout(() => statusDiv.classL
